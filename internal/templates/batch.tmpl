@echo off
REM Auto-generated from Babfile by bab - DO NOT EDIT
REM https://github.com/bab/bab

setlocal enabledelayedexpansion

{{if not .NoColor}}
REM Enable ANSI escape sequences (Windows 10+)
for /F %%a in ('echo prompt $E ^| cmd') do set "ESC=%%a"
{{end}}

if "%~1"=="" goto list_tasks

set "TASK_NAME=%~1"
shift

REM Task dispatcher
{{range .Tasks}}
if "%TASK_NAME%"=="{{.Name}}" goto task_{{.SafeName}}
{{end}}

{{if .NoColor}}
echo Error: Task '%TASK_NAME%' not found. 1>&2
{{else}}
echo %ESC%[91mError:%ESC%[0m Task '%ESC%[1m%TASK_NAME%%ESC%[0m' not found. 1>&2
{{end}}
echo.
echo Run 'bab.bat' to see available tasks.
exit /b 1

REM Task implementations
{{range .Tasks}}
:task_{{.SafeName}}
{{if $.NoColor}}
echo ^> Running task: {{.Name}}
{{else}}
echo %ESC%[96m^>%ESC%[0m Running task: %ESC%[1m{{.Name}}%ESC%[0m
{{end}}
{{range .Commands}}
{{.}}
if errorlevel 1 (
{{if $.NoColor}}
    echo Task failed with exit code !errorlevel! 1>&2
{{else}}
    echo %ESC%[91mTask failed with exit code !errorlevel!%ESC%[0m 1>&2
{{end}}
    exit /b !errorlevel!
)
{{end}}
{{if $.NoColor}}
echo + Task completed: {{.Name}}
{{else}}
echo %ESC%[92m+%ESC%[0m Task completed: %ESC%[1m{{.Name}}%ESC%[0m
{{end}}
goto :eof
{{end}}

:list_tasks
echo.
echo Available tasks:
{{if .RootTasks}}
{{range $task := .RootTasks}}
{{if $task.Description}}
echo {{pad $task.Name $.RootMaxNameLen}} - {{$task.Description}}
{{else}}
echo {{$task.Name}}
{{end}}
{{end}}
{{end}}
{{range $group, $tasks := .GroupedTasks}}
echo {{$group}}:
{{$maxLen := index $.GroupMaxNameLen $group}}
{{range $task := $tasks}}
{{$shortName := trimPrefix $task.Name (printf "%s:" $group)}}
{{if $task.Description}}
echo   {{pad $shortName $maxLen}} - {{$task.Description}}
{{else}}
echo   {{$shortName}}
{{end}}
{{end}}
{{end}}
echo.
echo Run 'bab.bat ^<task^>' to execute a task
goto :eof
